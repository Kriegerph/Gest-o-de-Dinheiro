<div class="row g-3 investments-page">
  <div class="col-12 d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div>
      <p class="text-uppercase text-primary small mb-1">Patrimônio</p>
      <h3 class="fw-bold mb-0">Investimentos</h3>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-light" type="button" (click)="resetForm()" *ngIf="editingId">
        Cancelar edição
      </button>
    </div>
  </div>

  <ng-container *ngIf="view$ | async as view; else loadingTpl">
    <div class="col-12">
      <div class="summary-grid">
        <div class="glass-card summary-card">
          <div class="summary-label">Total investido</div>
          <div class="summary-value">
            {{ view.summary.totalInvested | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
          </div>
          <div class="summary-sub">Capital aplicado</div>
        </div>
        <div class="glass-card summary-card">
          <div class="summary-label">Total atual estimado</div>
          <div class="summary-value">
            {{ view.summary.totalEstimated | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
          </div>
          <div class="summary-sub">Capital + rendimentos</div>
        </div>
        <div class="glass-card summary-card">
          <div class="summary-label">Rendimento</div>
          <div class="summary-value">
            {{ view.summary.totalYield | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
          </div>
          <div class="summary-sub">
            Rentabilidade: {{ view.summary.totalYieldPercent | number:'1.0-2' }}%
          </div>
        </div>
        <div class="glass-card summary-card">
          <div class="summary-label">Atualizado em</div>
          <div class="summary-value">{{ view.summary.updatedLabel }}</div>
          <div class="summary-tag">Estimado</div>
        </div>
      </div>
    </div>

    <div class="col-12" *ngIf="view.summary.indexMissing">
      <div class="glass-card p-3 text-warning">
        Sem índice atualizado para investimentos indexados.
      </div>
    </div>

    <div class="col-lg-4">
      <div class="glass-card p-3 h-100">
        <h6 class="fw-semibold mb-3">{{ editingId ? 'Editar investimento' : 'Novo investimento' }}</h6>
        <form [formGroup]="form" class="d-grid gap-3" (ngSubmit)="save()">
          <div>
            <label class="form-label text-secondary">Nome</label>
            <input class="form-control glass-input" formControlName="name" placeholder="Ex: Reserva" />
          </div>
          <div>
            <label class="form-label text-secondary">Tipo</label>
            <select class="form-select" formControlName="type" (change)="onTypeChange()">
              <option *ngFor="let option of typeOptions" [value]="option.value">{{ option.label }}</option>
            </select>
            <small class="text-secondary">
              Ex: Caixinha Nubank = Renda fixa + % do CDI (100) + capitalização diária.
            </small>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label text-secondary">Data de inicio real</label>
              <input type="date" class="form-control glass-input" formControlName="realStartDate" />
            </div>
            <div class="col-6">
              <label class="form-label text-secondary">Status</label>
              <select class="form-select" formControlName="status">
                <option *ngFor="let option of statusOptions" [value]="option.value">{{ option.label }}</option>
              </select>
            </div>
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="investment-before-app"
              formControlName="hadBeforeApp" (change)="onBeforeAppToggle()" />
            <label class="form-check-label" for="investment-before-app">
              Investimento ja existia antes do app?
            </label>
          </div>

          <div *ngIf="!isBeforeApp">
            <label class="form-label text-secondary">Valor aplicado inicial</label>
            <input type="number" class="form-control glass-input" formControlName="principalBase" step="0.01"
              placeholder="Ex: 5.000,00" />
          </div>

          <div *ngIf="isBeforeApp" class="d-grid gap-2">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label text-secondary">Data de alinhamento</label>
                <input type="date" class="form-control glass-input" formControlName="systemStartDate" />
              </div>
              <div class="col-6">
                <label class="form-label text-secondary">Valor atual</label>
                <input type="number" class="form-control glass-input" formControlName="currentValueAtOnboarding"
                  step="0.01" placeholder="Ex: 12.000,00" />
              </div>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label text-secondary">Total investido até hoje</label>
                <input type="number" class="form-control glass-input" formControlName="totalInvestedToDate"
                  step="0.01" placeholder="Opcional" />
              </div>
              <div class="col-6">
                <label class="form-label text-secondary">Rendimento acumulado até hoje</label>
                <input type="number" class="form-control glass-input" formControlName="preAppYield" step="0.01"
                  placeholder="Opcional" />
              </div>
            </div>
            <small class="text-secondary">
              Valores anteriores ao app servem para alinhar seu histórico. O app não recalcula o passado.
            </small>
          </div>

          <div>
            <label class="form-label text-secondary">Regra de rendimento</label>
            <select class="form-select" formControlName="yieldMode" (change)="onYieldModeChange()">
              <option *ngFor="let option of yieldOptions" [value]="option.value">{{ option.label }}</option>
            </select>
          </div>

          <div class="row g-2" *ngIf="isManualMode">
            <div class="col-6">
              <label class="form-label text-secondary">{{ manualRateLabel }}</label>
              <input type="number" class="form-control glass-input" formControlName="manualRate" step="0.01"
                placeholder="Ex: 1.2" />
            </div>
          </div>
          <div class="row g-2" *ngIf="isIndexMode">
            <div class="col-6" *ngIf="yieldMode === 'cdi_percent'">
              <label class="form-label text-secondary">% do CDI</label>
              <input type="number" class="form-control glass-input" formControlName="cdiPercent" step="0.01"
                placeholder="Ex: 100" />
            </div>
            <div [class.col-6]="yieldMode === 'cdi_percent'" [class.col-12]="yieldMode !== 'cdi_percent'">
              <label class="form-label text-secondary">Taxa placeholder (a.m.)</label>
              <input type="number" class="form-control glass-input" formControlName="manualRate" step="0.01"
                placeholder="Opcional" />
            </div>
          </div>
          <div class="row g-2">
            <div [class.col-6]="isManualMode" [class.col-12]="isIndexMode">
              <label class="form-label text-secondary">Capitalização</label>
              <select class="form-select" formControlName="compounding">
                <option value="monthly">Mensal</option>
                <option value="daily">Diária</option>
              </select>
            </div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary flex-grow-1" type="submit" [disabled]="saving">
              <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
              {{ saving ? 'Salvando...' : editingId ? 'Salvar alterações' : 'Adicionar' }}
            </button>
            <button class="btn btn-outline-light" type="button" (click)="resetForm()">Limpar</button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="glass-card p-3 h-100">
        <div class="table-responsive">
          <table class="table table-hover align-middle table-sm app-table investments-table">
            <thead>
              <tr class="text-secondary">
                <th>Investimento</th>
                <th class="text-end">Base</th>
                <th class="text-end">Atual estimado</th>
                <th class="text-end">Rendimento</th>
                <th>Status</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngIf="view.items.length > 0; else emptyInvestmentsTpl">
                <tr *ngFor="let item of view.items; trackBy: trackById">
                  <td>
                    <div class="fw-semibold">{{ item.name }}</div>
                    <div class="text-secondary small">{{ item.typeLabel }}</div>
                    <div class="text-secondary small" *ngIf="item.hadBeforeApp">
                      Rendimento pre-app: {{ item.preAppYield | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
                    </div>
                  </td>
                  <td class="text-end">
                    <div class="fw-semibold">
                      {{ item.principalBase | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
                    </div>
                    <div class="text-secondary small">Base no sistema</div>
                  </td>
                  <td class="text-end">
                    <div class="fw-semibold">
                      {{ item.totalEstimated | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
                    </div>
                    <div class="text-secondary small">Estimado</div>
                    <div class="text-warning small" *ngIf="item.indexMissing">
                      Sem índice atualizado
                    </div>
                    <div class="text-secondary small" *ngIf="item.placeholderUsed">
                      Taxa placeholder aplicada
                    </div>
                    <div class="text-secondary small">Atualizado em {{ item.updatedLabel }}</div>
                  </td>
                  <td class="text-end">
                    <div class="fw-semibold" [class.text-success]="item.totalYield >= 0"
                      [class.text-danger]="item.totalYield < 0">
                      {{ item.totalYield | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
                    </div>
                    <div class="text-secondary small">{{ item.totalReturnPercent | number:'1.0-2' }}%</div>
                    <div class="text-secondary small" *ngIf="item.hadBeforeApp">
                      Total (inclui antes do app)
                    </div>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="{
                      'bg-success-subtle text-success': item.status === 'active',
                      'bg-secondary-subtle text-secondary': item.status === 'inactive'
                    }">
                      {{ item.statusLabel }}
                    </span>
                  </td>
                  <td class="text-end actions-cell">
                    <div class="actions-stack">
                      <a class="btn btn-sm btn-outline-light action-btn action-btn--ghost" *ngIf="item.id"
                        [routerLink]="['/app/investments', item.id]"
                        title="Ver detalhes do investimento">
                        <i class="bi bi-box-arrow-up-right"></i>
                        <span class="action-label">Detalhes</span>
                      </a>
                      <button class="btn btn-sm btn-outline-light action-btn action-btn--ghost" type="button"
                        (click)="edit(item)" title="Editar investimento">
                        <i class="bi bi-pencil"></i>
                        <span class="action-label">Editar</span>
                      </button>
                    </div>
                  </td>
                </tr>
              </ng-container>
            </tbody>
            <ng-template #emptyInvestmentsTpl>
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <div>Nenhum investimento cadastrado.</div>
                    <button class="btn btn-sm btn-primary" type="button" (click)="resetForm()">
                      Novo investimento
                    </button>
                  </div>
                </td>
              </tr>
            </ng-template>
          </table>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="col-12">
      <div class="glass-card p-3">
        <div class="skeleton skeleton-line w-50 mb-2"></div>
        <div class="skeleton skeleton-line w-75"></div>
      </div>
    </div>
    <div class="col-12" *ngFor="let _ of skeletonRows">
      <div class="glass-card p-3">
        <div class="skeleton skeleton-line w-50 mb-2"></div>
        <div class="skeleton skeleton-line w-75"></div>
      </div>
    </div>
  </ng-template>

  <div class="modal-backdrop" *ngIf="showDepositModal" (click)="closeDeposit()">
    <div class="glass-card modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header-row">
        <h6 class="fw-semibold mb-0">Aportar em {{ selectedInvestment?.name }}</h6>
        <button class="btn btn-sm btn-outline-light" type="button" (click)="closeDeposit()">Fechar</button>
      </div>
      <form [formGroup]="depositForm" class="d-grid gap-3 mt-3" (ngSubmit)="confirmDeposit()">
        <div>
          <label class="form-label text-secondary">Valor</label>
          <input type="number" class="form-control glass-input" formControlName="amount" step="0.01"
            placeholder="Ex: 1.000,00" />
        </div>
        <div class="form-grid-fixed">
          <div class="form-field">
            <label class="form-label text-secondary">Data</label>
            <input type="date" class="form-control glass-input" formControlName="date" />
          </div>
          <div class="form-field account-field">
            <label class="form-label text-secondary">
              {{
                depositForm.get('isHistorical')?.value
                  ? 'Conta (opcional)'
                  : 'Conta de origem'
              }}
            </label>
            <select class="form-select" formControlName="accountId">
              <option value="" disabled>Selecione...</option>
              <option *ngFor="let account of (accounts$ | async)" [value]="account.id">
                {{ account.name }}
              </option>
            </select>
          </div>
        </div>
        <div class="historical-block">
          <div class="historical-toggle">
            <div class="form-check form-switch">
              <input class="form-check-input toggle-switch" type="checkbox" formControlName="isHistorical"
                (change)="onDepositHistoricalToggle()" id="deposit-historical-toggle" />
              <label class="form-check-label toggle-label" for="deposit-historical-toggle">
                Movimentação anterior ao cadastro do investimento (histórico)
              </label>
            </div>
          </div>
          <small class="text-secondary historical-helper"
            [class.historical-helper--hidden]="!depositForm.get('isHistorical')?.value">
            Não gera lançamento e não altera o saldo das contas. Serve apenas para montar o histórico.
          </small>
        </div>

        <div>
          <label class="form-label text-secondary">Observação</label>
          <input class="form-control glass-input" formControlName="notes" placeholder="Opcional" />
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-grow-1" type="submit" [disabled]="submittingDeposit">
            <span *ngIf="submittingDeposit" class="spinner-border spinner-border-sm me-2"></span>
            {{ depositForm.get('isHistorical')?.value ? 'Registrar no histórico' : 'Confirmar aporte' }}
          </button>
          <button class="btn btn-outline-light" type="button" (click)="closeDeposit()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="showWithdrawModal" (click)="closeWithdraw()">
    <div class="glass-card modal-card" (click)="$event.stopPropagation()">
      <div class="modal-header-row">
        <h6 class="fw-semibold mb-0">Resgatar de {{ selectedInvestment?.name }}</h6>
        <button class="btn btn-sm btn-outline-light" type="button" (click)="closeWithdraw()">Fechar</button>
      </div>
      <div class="text-secondary small mt-2">
        Valor estimado atual:
        {{ selectedInvestment?.totalEstimated | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
      </div>
      <div class="text-warning small" *ngIf="selectedInvestment?.indexMissing">
        Valor estimado. Sem índice atualizado.
      </div>
      <form [formGroup]="withdrawForm" class="d-grid gap-3 mt-3" (ngSubmit)="confirmWithdraw()">
        <div>
          <label class="form-label text-secondary">Valor</label>
          <input type="number" class="form-control glass-input" formControlName="amount" step="0.01"
            placeholder="Ex: 1.000,00" />
        </div>
        <div class="form-grid-fixed">
          <div class="form-field">
            <label class="form-label text-secondary">Data</label>
            <input type="date" class="form-control glass-input" formControlName="date" />
          </div>
          <div class="form-field account-field">
            <label class="form-label text-secondary">
              {{
                withdrawForm.get('isHistorical')?.value
                  ? 'Conta (opcional)'
                  : 'Conta de destino'
              }}
            </label>
            <select class="form-select" formControlName="accountId">
              <option value="" disabled>Selecione...</option>
              <option *ngFor="let account of (accounts$ | async)" [value]="account.id">
                {{ account.name }}
              </option>
            </select>
          </div>
        </div>
        <div class="historical-block">
          <div class="historical-toggle">
            <div class="form-check form-switch">
              <input class="form-check-input toggle-switch" type="checkbox" formControlName="isHistorical"
                (change)="onWithdrawHistoricalToggle()" id="withdraw-historical-toggle" />
              <label class="form-check-label toggle-label" for="withdraw-historical-toggle">
                Movimentação anterior ao cadastro do investimento (histórico)
              </label>
            </div>
          </div>
          <small class="text-secondary historical-helper"
            [class.historical-helper--hidden]="!withdrawForm.get('isHistorical')?.value">
            Não gera lançamento e não altera o saldo das contas. Serve apenas para montar o histórico.
          </small>
        </div>
        <div *ngIf="!withdrawForm.get('isHistorical')?.value">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" formControlName="applyIr"
              id="withdraw-ir-toggle" />
            <label class="form-check-label" for="withdraw-ir-toggle">
              Descontar IR automaticamente (estimativa)
            </label>
          </div>
          <small class="text-secondary">
            O valor líquido considera o desconto estimado de Imposto de Renda, como ocorre nos bancos.
          </small>
        </div>
        <div class="ir-preview" *ngIf="withdrawIrEstimate as ir">
          <div class="ir-row">
            <span>Lucro estimado</span>
            <strong>{{ ir.profitPortion | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</strong>
          </div>
          <div class="ir-row">
            <span>Alíquota de IR (%)</span>
            <strong>{{ ir.irRate * 100 | number:'1.0-2' }}</strong>
          </div>
          <div class="ir-row">
            <span>IR estimado</span>
            <strong>{{ ir.irValue | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</strong>
          </div>
          <div class="ir-row">
            <span>Valor líquido a receber</span>
            <strong>{{ ir.netAmount | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</strong>
          </div>
        </div>
        <div>
          <label class="form-label text-secondary">Observacao</label>
          <input class="form-control glass-input" formControlName="notes" placeholder="Opcional" />
        </div>
        <div class="text-secondary small" *ngIf="!withdrawForm.get('isHistorical')?.value">
          Valores estimados. O desconto real pode variar conforme regras do banco.
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-primary flex-grow-1" type="submit" [disabled]="submittingWithdraw">
            <span *ngIf="submittingWithdraw" class="spinner-border spinner-border-sm me-2"></span>
            {{ withdrawForm.get('isHistorical')?.value ? 'Registrar no historico' : 'Confirmar resgate' }}
          </button>
          <button class="btn btn-outline-light" type="button" (click)="closeWithdraw()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>
