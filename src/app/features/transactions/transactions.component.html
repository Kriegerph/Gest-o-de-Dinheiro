<div class="transactions-page" *ngIf="categories$ | async as categories">
  <ng-container *ngIf="accounts$ | async as accounts">
    <div class="row g-3 transactions-grid">
      <div class="col-12">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <p class="text-uppercase text-primary small mb-1">Fluxo</p>
            <h3 class="fw-bold mb-0">Lançamentos</h3>
          </div>
        </div>
      </div>

    <div class="col-lg-5 transactions-form-col">
      <div class="glass-card p-3 h-100">
        <h6 class="fw-semibold mb-3">{{ editingId ? 'Editar lançamento' : 'Novo lançamento' }}</h6>
        <form [formGroup]="form" class="d-grid gap-3" (ngSubmit)="save()">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label text-secondary d-block">Tipo</label>
              <div class="btn-group w-100" role="group" aria-label="Tipo">
                <input type="checkbox" class="btn-check" id="tx-type-income" autocomplete="off"
                  [checked]="form.get('type')?.value === 'income'" (click)="toggleType('income')" />
                <label class="btn btn-outline-success flex-fill" for="tx-type-income">Receita</label>
                <input type="checkbox" class="btn-check" id="tx-type-expense" autocomplete="off"
                  [checked]="form.get('type')?.value === 'expense'" (click)="toggleType('expense')" />
                <label class="btn btn-outline-danger flex-fill" for="tx-type-expense">Despesa</label>
                <input type="checkbox" class="btn-check" id="tx-type-transfer" autocomplete="off"
                  [checked]="form.get('type')?.value === 'transfer'" (click)="toggleType('transfer')" />
                <label class="btn btn-outline-info flex-fill" for="tx-type-transfer">Transferência</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label text-secondary">Data</label>
              <input type="date" class="form-control glass-input" formControlName="date" />
            </div>
          </div>
          <div>
            <label class="form-label text-secondary">Descrição</label>
            <input class="form-control glass-input" formControlName="description" placeholder="Ex: Supermercado" />
          </div>
          <div>
            <label class="form-label text-secondary">Valor</label>
            <input type="number" class="form-control glass-input" formControlName="amount" placeholder="Ex: 150.00"
              min="0.01" step="0.01" />
          </div>
          <ng-container *ngIf="form.get('type')?.value !== 'transfer'">
            <div *ngIf="filteredCategories$ | async as filteredCategories">
              <label class="form-label text-secondary">Categoria</label>
              <select class="form-select glass-input" formControlName="categoryId"
                [class.is-invalid]="form.get('categoryId')?.touched && form.get('categoryId')?.invalid">
                <ng-container *ngIf="form.get('type')?.value">
                  <option value="" disabled>Selecione...</option>
                  <option *ngFor="let c of filteredCategories" [value]="c.id">{{ c.name }}</option>
                </ng-container>
              </select>
              <div class="invalid-feedback">Selecione uma categoria.</div>
              <small class="text-secondary" *ngIf="!form.get('type')?.value">
                Selecione o tipo (receita/despesa) para ver categorias.
              </small>
            </div>
          </ng-container>
          <ng-container *ngIf="form.get('type')?.value === 'transfer'; else singleAccount">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label text-secondary">Conta origem</label>
                <select class="form-select glass-input" formControlName="accountOriginId"
                  [class.is-invalid]="form.get('accountOriginId')?.touched && form.get('accountOriginId')?.invalid">
                  <option value="" disabled>Selecione...</option>
                  <option *ngFor="let account of accounts" [value]="account.id">{{ account.name }}</option>
                </select>
                <div class="invalid-feedback">Selecione a conta de origem.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label text-secondary">Conta destino</label>
                <select class="form-select glass-input" formControlName="accountDestinationId"
                  [class.is-invalid]="form.get('accountDestinationId')?.touched && form.get('accountDestinationId')?.invalid">
                  <option value="" disabled>Selecione...</option>
                  <option *ngFor="let account of accounts" [value]="account.id">{{ account.name }}</option>
                </select>
                <div class="invalid-feedback">Selecione a conta de destino.</div>
              </div>
            </div>
            <small class="text-secondary" *ngIf="accounts.length === 0">
              Cadastre uma conta antes de transferir.
            </small>
          </ng-container>
          <ng-template #singleAccount>
            <div>
              <label class="form-label text-secondary">Conta</label>
              <select class="form-select glass-input" formControlName="accountId"
                [class.is-invalid]="form.get('accountId')?.touched && form.get('accountId')?.invalid">
                <option value="" disabled>Selecione...</option>
                <option *ngFor="let account of accounts" [value]="account.id">{{ account.name }}</option>
              </select>
              <div class="invalid-feedback">Selecione uma conta.</div>
              <small class="text-secondary" *ngIf="accounts.length === 0">
                Cadastre uma conta para continuar.
              </small>
            </div>
          </ng-template>
          <div>
            <label class="form-label text-secondary">Observações</label>
            <textarea rows="2" class="form-control glass-input" formControlName="notes"></textarea>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary flex-grow-1" type="submit"
              [disabled]="form.invalid || form.get('type')?.value === null || saving">
              <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
              {{ saving ? 'Salvando...' : editingId ? 'Salvar' : 'Adicionar' }}
            </button>
            <button class="btn btn-outline-light" type="button" (click)="resetForm()">Limpar</button>
          </div>
        </form>
      </div>
    </div>

    <div class="col-lg-7 transactions-list-col">
      <div class="glass-card p-3 list-card">
        <div class="history-header">
          <div class="history-title">
            <h6 class="fw-semibold mb-0">Historico de lancamentos</h6>
            <ng-container *ngIf="hasActiveFilters$ | async as hasActiveFilters">
              <div class="text-secondary small" *ngIf="hasActiveFilters">
                <div *ngIf="transactionsCount$ | async as count">
                  {{ count }} lancamentos encontrados
                </div>
              </div>
            </ng-container>
          </div>
          <div class="history-actions">
            <div class="filters-toolbar">
              <button class="btn btn-outline-light btn-sm filters-toggle" type="button" (click)="toggleFilters()"
                [class.active]="hasActiveFilters$ | async">
                <i class="bi bi-funnel me-1"></i>
                Filtros
                <ng-container *ngIf="activeFilterChips$ | async as chips">
                  <span class="badge bg-info-subtle text-info ms-2" *ngIf="chips.length">
                    {{ chips.length }}
                  </span>
                </ng-container>
              </button>
              <div class="filters-popover" *ngIf="isFiltersOpen" (click)="$event.stopPropagation()">
                <div class="glass-card p-3 filters-panel" (click)="$event.stopPropagation()">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="fw-semibold">Filtros</div>
                    <button class="btn btn-sm btn-outline-light" type="button" (click)="closeFilters()">
                      <i class="bi bi-x-lg"></i>
                    </button>
                  </div>
                  <form [formGroup]="filtersDraftForm" class="row g-3" (ngSubmit)="applyFiltersAndClose()">
                    <div class="col-12 col-md-6">
                      <label class="form-label text-secondary">Categoria</label>
                      <select class="form-select glass-input" formControlName="categoryId">
                        <option [ngValue]="null">Todas as categorias</option>
                        <option *ngFor="let c of categories" [ngValue]="c.id">{{ c.name }}</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label text-secondary">Tipo</label>
                      <select class="form-select glass-input" formControlName="type">
                        <option value="all">Todos</option>
                        <option value="income">Entrada</option>
                        <option value="expense">Saida</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label text-secondary">Conta</label>
                      <select class="form-select glass-input" formControlName="accountId">
                        <option [ngValue]="null">Todas as contas</option>
                        <option *ngFor="let account of accounts" [ngValue]="account.id">{{ account.name }}</option>
                      </select>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label text-secondary">Busca</label>
                      <input class="form-control glass-input" formControlName="q"
                        placeholder="Descricao ou observacoes" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label text-secondary">Data de</label>
                      <input type="date" class="form-control glass-input" formControlName="dateFrom" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label text-secondary">Data ate</label>
                      <input type="date" class="form-control glass-input" formControlName="dateTo" />
                    </div>
                    <div class="col-12">
                      <div class="d-flex gap-2">
                        <button class="btn btn-primary flex-grow-1" type="submit">Aplicar</button>
                        <button class="btn btn-outline-light" type="button" (click)="clearFiltersAndClose()">
                          Limpar filtros
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-container *ngIf="activeFilterChips$ | async as chips">
          <div class="filters-chips mt-2" *ngIf="chips.length > 0">
            <span class="filter-chip" *ngFor="let chip of chips">{{ chip }}</span>
          </div>
        </ng-container>
        <div class="history-scroll">
          <div class="table-responsive">
            <table class="table table-hover align-middle table-sm app-table">
            <thead>
              <tr class="text-secondary">
                <th>Data</th>
                <th>Descrição</th>
                <th>Tipo</th>
                <th>Categoria</th>
                <th>Conta</th>
                <th class="text-end">Valor</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngIf="transactionsView$ | async as transactions; else loadingTransactionsTpl">
                <ng-container *ngIf="transactions.length > 0; else emptyTransactionsTpl">
                  <tr *ngFor="let tx of transactions; trackBy: trackById">
                    <td>{{ formatDate(tx.date) }}</td>
                    <td class="text-truncate" style="max-width: 220px;">{{ tx.description }}</td>
                    <td>
                      <span class="badge" [ngClass]="{
                      'bg-success-subtle text-success': tx.type === 'income',
                      'bg-danger-subtle text-danger': tx.type === 'expense',
                      'bg-info-subtle text-info': tx.type === 'transfer'
                    }">{{
                        tx.type === 'income' ? 'Receita' : tx.type === 'expense' ? 'Despesa' : 'Transferência'
                        }}</span>
                    </td>
                    <td>{{ tx.type === 'transfer' ? '-' : getCategoryName(categories, tx.categoryId) }}</td>
                    <td>
                      {{
                      tx.type === 'transfer'
                      ? getTransferLabel(accounts, tx)
                      : getAccountName(accounts, tx.accountId)
                      }}
                    </td>
                    <td class="text-end fw-semibold">
                      {{ tx.amount | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}
                    </td>
                    <td class="text-end text-nowrap">
                      <div class="d-inline-flex align-items-center flex-nowrap">
                        <button class="btn btn-sm btn-outline-light me-2" (click)="edit(tx)">
                          <i class="bi bi-pencil me-1"></i>
                          Editar
                        </button>
                        <button class="btn btn-sm btn-outline-light" (click)="delete(tx)">
                          <i class="bi bi-trash me-1"></i>
                          Excluir
                        </button>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </ng-container>
            </tbody>
            <ng-template #loadingTransactionsTpl>
              <tr *ngFor="let _ of skeletonRows">
                <td>
                  <div class="skeleton skeleton-line w-75"></div>
                </td>
                <td>
                  <div class="skeleton skeleton-line w-100"></div>
                </td>
                <td>
                  <div class="skeleton skeleton-line w-75"></div>
                </td>
                <td>
                  <div class="skeleton skeleton-line w-75"></div>
                </td>
                <td>
                  <div class="skeleton skeleton-line w-75"></div>
                </td>
                <td class="text-end">
                  <div class="skeleton skeleton-line w-50 ms-auto"></div>
                </td>
                <td class="text-end">
                  <div class="skeleton skeleton-line w-50 ms-auto"></div>
                </td>
              </tr>
            </ng-template>
            <ng-template #emptyTransactionsTpl>
              <tr>
                <td colspan="7">
                  <div class="empty-state">
                    <div>Nenhum dado encontrado para este período.</div>
                    <button class="btn btn-sm btn-primary" type="button" (click)="resetForm()">
                      Adicionar lançamento
                    </button>
                  </div>
                </td>
              </tr>
            </ng-template>
            </table>
          </div>
        </div>
      </div>
      <div class="filters-backdrop" *ngIf="isFiltersOpen" (click)="closeFilters()"></div>
    </div>
    </div>
  </ng-container>
</div>
